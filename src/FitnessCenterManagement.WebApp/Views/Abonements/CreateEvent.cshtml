@using FitnessCenterManagement.WebApp.Views.Shared.Resources
@using FitnessCenterManagement.WebApp.Views.FitnessEvents.Resources
@using FitnessCenterManagement.WebApp.Views.Abonements.Resources
@model FitnessCenterManagement.WebApp.Models.AbonementFitnessEventModel
@{
    ViewData["Title"] = AbonementsRes.AddFitnessEvent;
}

<h2>@ViewData["Title"]</h2>
<hr />
<form asp-controller="Abonements" asp-action="createEvent" asp-antiforgery="true" method="post">
    <div class="validation" asp-validation-summary="ModelOnly"></div>
    <input asp-for="Id" hidden="hidden" />
    <input asp-for="AbonementId" hidden="hidden" />

    <div class="form-group row">
        <label asp-for="FitnessEventId" class="col-md-2 control-label"></label>
        <div class="col-sm-10">
            <select asp-for="FitnessEventId" class="form-control">
                <option value="" id="dropDownServicesChooseValue" disabled="disabled" selected="selected">@SharedStringRes.ChooseDropdownHint</option>
            </select>
        </div>
    </div>

    <div class="form-group row">
        <div class="col-sm-10">
            <input type="submit" class="btn btn-primary btn-icon" value="@SharedStringRes.CreateBtn" />
        </div>
    </div>
</form>

<a asp-action="Info" asp-controller="Abonements" asp-route-id="@Model.AbonementId" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left"></i>
    <span>@SharedStringRes.GoBackBtn</span>
</a>

@section Scripts{
    <script>
        $(document).ready(loadDropdown());

        function loadDropdown() {
            var dropdownElement = document.getElementsByTagName("select")[0].children[0];
            var events = 
                $.ajax({
                    type: 'GET',
                    url: '/Abonements/'+@Model.AbonementId+'/fitnessEvents',
                    error: function (error) {
                        console.log('Error with receiving data: ' + error)
                    },
                    success: function (result) {
                        ajaxLoad(dropdownElement, result);
                    }
                });
        };
        function ajaxLoad(dropdownElement, takenEvents) {
            $.ajax({
                type: 'GET',
                url: '/FitnessEvents/items',
                error: function (error) {
                    console.log('Error with receiving data: ' + error)
                },
                success: function (result) {
                    let s = '';
                    if (result.length > 0) {
                        for (let el of result) {
                            if (!isAmongUsed(takenEvents, el.id)) {
                                s += '<option value="' + el.id + '"> ' + el.serviceInfo + ' - ' + el.venueInfo + ' (' + el.minutes + ' min) </option>';
                            }
                        }
                    }
                    $(dropdownElement).after(s);
                }
            });
        }

        function isAmongUsed(arr, value) {
            for (let one of arr) {
                if (one == value)
                    return true;
            }
            return false;
        }
    </script>
}